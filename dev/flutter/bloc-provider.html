<!DOCTYPE html>
<html lang="th-TH">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>BLoC Pattern กับการทำ Testing | Intception Hideout</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Flutter กับ BLoC PatternBLoC (Business Logic Component) เป็นรูปแบบหนึ่งในการจัดการส่วนของ Business Logic...">
    <meta name="image" content="https://blog.intception.me/flutter/bloc-provider.jpg">
    <meta name="twitter:title" content="BLoC Pattern กับการทำ Testing">
    <meta name="twitter:description" content="Flutter กับ BLoC PatternBLoC (Business Logic Component) เป็นรูปแบบหนึ่งในการจัดการส่วนของ Business Logic...">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://blog.intception.me/flutter/bloc-provider.jpg">
    <meta name="twitter:url" content="https://blog.intception.me/dev/flutter/bloc-provider.html">
    <meta property="og:type" content="article">
    <meta property="og:title" content="BLoC Pattern กับการทำ Testing">
    <meta property="og:description" content="Flutter กับ BLoC PatternBLoC (Business Logic Component) เป็นรูปแบบหนึ่งในการจัดการส่วนของ Business Logic...">
    <meta property="og:image" content="https://blog.intception.me/flutter/bloc-provider.jpg">
    <meta property="og:url" content="https://blog.intception.me/dev/flutter/bloc-provider.html">
    <meta property="og:site_name" content="Intception Hideout">
    <meta property="article:author" content="https://www.facebook.com/100002134179036">
    <meta property="article:published_time" content="August 15, 2019 00:00:00">
    <meta property="article:tag" content="dev">
    <meta itemprop="name" content="BLoC Pattern กับการทำ Testing">
    <meta itemprop="description" content="Flutter กับ BLoC PatternBLoC (Business Logic Component) เป็นรูปแบบหนึ่งในการจัดการส่วนของ Business Logic...">
    <meta itemprop="image" content="https://blog.intception.me/flutter/bloc-provider.jpg">
    <meta property="fb:app_id" content="378991759371355">
    <meta property="article:publisher" content="https://www.facebook.com/intception">
    
    <link rel="preload" href="/assets/css/0.styles.9fcaea78.css" as="style"><link rel="preload" href="/assets/js/app.e8816fbe.js" as="script"><link rel="preload" href="/assets/js/23.98f77880.js" as="script"><link rel="preload" href="/assets/js/2.5511de28.js" as="script"><link rel="preload" href="/assets/js/31.4cee5970.js" as="script"><link rel="preload" href="/assets/js/30.ceffa3ae.js" as="script"><link rel="preload" href="/assets/js/29.6bb21054.js" as="script"><link rel="preload" href="/assets/js/41.a1cbfaa2.js" as="script"><link rel="prefetch" href="/assets/js/1.7038105b.js"><link rel="prefetch" href="/assets/js/10.93173d2d.js"><link rel="prefetch" href="/assets/js/11.0f9c5f1c.js"><link rel="prefetch" href="/assets/js/12.91b64e47.js"><link rel="prefetch" href="/assets/js/13.08a3a51f.js"><link rel="prefetch" href="/assets/js/14.c8e0a547.js"><link rel="prefetch" href="/assets/js/15.43c6b249.js"><link rel="prefetch" href="/assets/js/16.99ef011c.js"><link rel="prefetch" href="/assets/js/17.b660276a.js"><link rel="prefetch" href="/assets/js/18.7c32fc21.js"><link rel="prefetch" href="/assets/js/19.3aa4ded7.js"><link rel="prefetch" href="/assets/js/20.f9256596.js"><link rel="prefetch" href="/assets/js/21.4dd2eea6.js"><link rel="prefetch" href="/assets/js/22.bebac973.js"><link rel="prefetch" href="/assets/js/24.97336265.js"><link rel="prefetch" href="/assets/js/25.c15aed46.js"><link rel="prefetch" href="/assets/js/26.cdb80987.js"><link rel="prefetch" href="/assets/js/27.061d534a.js"><link rel="prefetch" href="/assets/js/28.a7dedf0a.js"><link rel="prefetch" href="/assets/js/32.958c025c.js"><link rel="prefetch" href="/assets/js/33.1baa13ba.js"><link rel="prefetch" href="/assets/js/34.d9701686.js"><link rel="prefetch" href="/assets/js/35.25566597.js"><link rel="prefetch" href="/assets/js/36.455eb1cd.js"><link rel="prefetch" href="/assets/js/37.f9701788.js"><link rel="prefetch" href="/assets/js/38.7adbe429.js"><link rel="prefetch" href="/assets/js/39.0e42479f.js"><link rel="prefetch" href="/assets/js/4.d70afffc.js"><link rel="prefetch" href="/assets/js/40.6427dc18.js"><link rel="prefetch" href="/assets/js/42.a1b17ae6.js"><link rel="prefetch" href="/assets/js/43.b629483d.js"><link rel="prefetch" href="/assets/js/44.3ce67008.js"><link rel="prefetch" href="/assets/js/45.58b17ad5.js"><link rel="prefetch" href="/assets/js/46.68e3b49f.js"><link rel="prefetch" href="/assets/js/47.72e2cea9.js"><link rel="prefetch" href="/assets/js/48.2928f898.js"><link rel="prefetch" href="/assets/js/49.94a83419.js"><link rel="prefetch" href="/assets/js/5.dbd44f85.js"><link rel="prefetch" href="/assets/js/6.2ecdc96d.js"><link rel="prefetch" href="/assets/js/7.1abc7760.js"><link rel="prefetch" href="/assets/js/8.47b30f38.js"><link rel="prefetch" href="/assets/js/9.3d2ae7fe.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9fcaea78.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div data-v-500e1d8c><div class="theme-container" data-v-500e1d8c><header class="navbar" data-v-500e1d8c><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="Intception Hideout" class="logo"> <span class="site-name can-hide">Intception Hideout</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/dev/" class="nav-link router-link-active">Dev</a></div><div class="nav-item"><a href="/lifestyle/" class="nav-link">Lifestyle</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-500e1d8c></div> <aside class="sidebar" data-v-500e1d8c><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/dev/" class="nav-link router-link-active">Dev</a></div><div class="nav-item"><a href="/lifestyle/" class="nav-link">Lifestyle</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>BLoC Pattern กับการทำ Testing</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/dev/flutter/bloc-provider.html#ลองสร้างโปรเจคกันก่อน" class="sidebar-link">ลองสร้างโปรเจคกันก่อน</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/dev/flutter/bloc-provider.html#การเขียนในรูปแบบเริ่มต้น" class="sidebar-link">การเขียนในรูปแบบเริ่มต้น</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dev/flutter/bloc-provider.html#ข้อดี" class="sidebar-link">ข้อดี</a></li><li class="sidebar-sub-header"><a href="/dev/flutter/bloc-provider.html#ข้อเสีย" class="sidebar-link">ข้อเสีย</a></li><li class="sidebar-sub-header"><a href="/dev/flutter/bloc-provider.html#ปัญหา" class="sidebar-link">ปัญหา</a></li></ul></li><li><a href="/dev/flutter/bloc-provider.html#bloc-ผู้ช่วยให้รอดของเรา" class="sidebar-link">BLoC ผู้ช่วยให้รอดของเรา</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dev/flutter/bloc-provider.html#ติดตั้ง-library-ที่จําเป็น" class="sidebar-link">ติดตั้ง Library ที่จำเป็น</a></li><li class="sidebar-sub-header"><a href="/dev/flutter/bloc-provider.html#เริ่มเขียนไฟล์-bloc" class="sidebar-link">เริ่มเขียนไฟล์ BLoC</a></li><li class="sidebar-sub-header"><a href="/dev/flutter/bloc-provider.html#เปลี่ยนโปรแกรมเดิมๆของเรา" class="sidebar-link">เปลี่ยนโปรแกรมเดิมๆของเรา</a></li><li class="sidebar-sub-header"><a href="/dev/flutter/bloc-provider.html#ลองรัน-widget-testing-ใหม่อีกครั้ง" class="sidebar-link">ลองรัน Widget Testing ใหม่อีกครั้ง</a></li></ul></li><li><a href="/dev/flutter/bloc-provider.html#เริ่มเขียน-unit-testing-กันเถอะ" class="sidebar-link">เริ่มเขียน Unit Testing กันเถอะ</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/dev/flutter/bloc-provider.html#สรุป" class="sidebar-link">สรุป</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page" data-v-500e1d8c> <div class="theme-default-content content__default"><h1 id="bloc-pattern-กับการทํา-testing"><a href="#bloc-pattern-กับการทํา-testing" class="header-anchor">#</a> BLoC Pattern กับการทำ Testing</h1> <span data-v-11962d9e><a href="/?tag=dev" class="tag-element" data-v-eeb2ca7e data-v-11962d9e>#Dev</a><a href="/?tag=flutter" class="tag-element" data-v-eeb2ca7e data-v-11962d9e>#Flutter</a><a href="/?tag=testing" class="tag-element" data-v-eeb2ca7e data-v-11962d9e>#Testing</a></span> <p>BLoC (Business Logic Component) เป็นรูปแบบหนึ่งในการจัดการส่วนของ Business Logic ของแอปที่เขียนบน Flutter ซึ่งทาง Google เริ่มแนะนำมาตั้งแต่ปี 2018<br>
โดยรูปแบบนี้ง่ายต่อการจัดการโค้ด และสามารถทำให้เราทดสอบแอปหรือ ทำ Unit Testing ได้ง่ายขึ้น</p> <img src="/assets/img/00.05755785.jpg" alt="Header"><h2 id="ลองสร้างโปรเจคกันก่อน"><a href="#ลองสร้างโปรเจคกันก่อน" class="header-anchor">#</a> ลองสร้างโปรเจคกันก่อน</h2> <ol><li>รันคำสั่งใน Command line เพื่อสร้างโปรเจค Flutter</li></ol> <div class="language-sh extra-class"><pre class="language-sh"><code>flutter create bloc_provider <span class="token comment"># สร้างโปรเจคชื่อ bloc_provider</span>
</code></pre></div><ol start="2"><li>รันคำสั่ง Command line เพื่อรันแอปบน Emulator (ต้องเปิด Emulator ก่อนนะ) หรือถ้าเขียนโดยใช้ Visual Studio Code ก็สามารถกด F5 แทนได้</li></ol> <div class="language-sh extra-class"><pre class="language-sh"><code>flutter run
</code></pre></div><p>และนี่ก็คือหน้าจอเริ่มต้นที่ Flutter สร้างมาให้ เป็นโปรแกรมที่มีปุ่ม + เมื่อกดแล้วก็จะเพิ่มจำนวนนับบนหน้าจอ 😁</p> <center class="medium-zoom"><div class="force-max" style="max-width:50%;"><img src="/assets/img/01.bdce6aa4.png" alt="Title"></div> <div class="caption">ซึ่งในบทความนี้เราไม่ได้ใช้ Emulator หรอกรันเทสล้วนๆ 🤣</div></center> <p>โดยโค้ดโปรแกรมของเราจะอยู่ใน <code>lib/main.dart</code></p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token keyword">import</span> <span class="token string">'package:flutter/material.dart'</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">runApp</span><span class="token punctuation">(</span><span class="token function">MyApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">MyApp</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{</span>
  <span class="token metadata symbol">@override</span>
  Widget <span class="token function">build</span><span class="token punctuation">(</span>BuildContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">MaterialApp</span><span class="token punctuation">(</span>
      title<span class="token punctuation">:</span> <span class="token string">'Flutter Demo'</span><span class="token punctuation">,</span>
      theme<span class="token punctuation">:</span> <span class="token function">ThemeData</span><span class="token punctuation">(</span>
        primarySwatch<span class="token punctuation">:</span> Colors<span class="token punctuation">.</span>blue<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      home<span class="token punctuation">:</span> <span class="token function">MyHomePage</span><span class="token punctuation">(</span>title<span class="token punctuation">:</span> <span class="token string">'Flutter Demo Home Page'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">MyHomePage</span> <span class="token keyword">extends</span> <span class="token class-name">StatefulWidget</span> <span class="token punctuation">{</span>
  <span class="token function">MyHomePage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>Key key<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">final</span> String title<span class="token punctuation">;</span>

  <span class="token metadata symbol">@override</span>
  _MyHomePageState <span class="token function">createState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">_MyHomePageState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">_MyHomePageState</span> <span class="token keyword">extends</span> <span class="token class-name">State</span><span class="token operator">&lt;</span>MyHomePage<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  int _counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">_incrementCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _counter<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata symbol">@override</span>
  Widget <span class="token function">build</span><span class="token punctuation">(</span>BuildContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">Scaffold</span><span class="token punctuation">(</span>
      appBar<span class="token punctuation">:</span> <span class="token function">AppBar</span><span class="token punctuation">(</span>
        title<span class="token punctuation">:</span> <span class="token function">Text</span><span class="token punctuation">(</span>widget<span class="token punctuation">.</span>title<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      body<span class="token punctuation">:</span> <span class="token function">Center</span><span class="token punctuation">(</span>
        child<span class="token punctuation">:</span> <span class="token function">Column</span><span class="token punctuation">(</span>
          mainAxisAlignment<span class="token punctuation">:</span> MainAxisAlignment<span class="token punctuation">.</span>center<span class="token punctuation">,</span>
          children<span class="token punctuation">:</span> <span class="token operator">&lt;</span>Widget<span class="token operator">&gt;</span><span class="token punctuation">[</span>
            <span class="token function">Text</span><span class="token punctuation">(</span>
              <span class="token string">'You have pushed the button this many times:'</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">Text</span><span class="token punctuation">(</span>
              <span class="token string">'$_counter'</span><span class="token punctuation">,</span>
              style<span class="token punctuation">:</span> Theme<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span>textTheme<span class="token punctuation">.</span>display1<span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      floatingActionButton<span class="token punctuation">:</span> <span class="token function">FloatingActionButton</span><span class="token punctuation">(</span>
        onPressed<span class="token punctuation">:</span> _incrementCounter<span class="token punctuation">,</span>
        tooltip<span class="token punctuation">:</span> <span class="token string">'Increment'</span><span class="token punctuation">,</span>
        child<span class="token punctuation">:</span> <span class="token function">Icon</span><span class="token punctuation">(</span>Icons<span class="token punctuation">.</span>add<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>และโค้ดในส่วนของการทำ Testing จะอยู่ใน <code>test/widget_test.dart</code> ซึ่งเป็นการจำลองการทำงานจริงของโปรแกรม เช่น การกดปุ่ม การพิพม์ สิ่งต่างๆ</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token keyword">import</span> <span class="token string">'package:flutter/material.dart'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'package:flutter_test/flutter_test.dart'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">'package:bloc_provider/main.dart'</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">testWidgets</span><span class="token punctuation">(</span><span class="token string">'Counter increments smoke test'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>WidgetTester tester<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token comment">// ทำการสร้าง MyApp แล้วใส่เข้าไปในตัวรันแอป</span>
    <span class="token keyword">await</span> tester<span class="token punctuation">.</span><span class="token function">pumpWidget</span><span class="token punctuation">(</span><span class="token function">MyApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// เป็นการหาว่ามี Text ที่แสดงค่า 0 อยู่ในแอปรึเปล่า</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>find<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> findsOneWidget<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// เป็นการหาว่าไม่มี Text ที่แสดงค่า 1 อยู่ในแอป</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>find<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> findsNothing<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// สั่งให้กดปุ่มที่มีไอค่อนรูป '+'</span>
    <span class="token keyword">await</span> tester<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>find<span class="token punctuation">.</span><span class="token function">byIcon</span><span class="token punctuation">(</span>Icons<span class="token punctuation">.</span>add<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// สั่งให้แอปรอการทำงาน</span>
    <span class="token keyword">await</span> tester<span class="token punctuation">.</span><span class="token function">pump</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// เป็นการหาว่ามี Text ที่แสดงค่า 1 อยู่ในแอปรึเปล่า</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>find<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> findsNothing<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// เป็นการหาว่าไม่มี Text ที่แสดงค่า 0 อยู่ในแอป</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>find<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> findsOneWidget<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>ถ้าใครคุ้นชินกับพวก Javascript, jQuery ก็จะมีแนวการทำงานคล้ายๆกัน</p></blockquote> <p>ทีนี้ถ้าผมอยากจะเขียน Unit Testing สำหรับแอปนี้ล่ะ?
ในที่นี้ผมจะลองสร้างไฟล์ <code>test/unit_test.dart</code> ขึ้นมา</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token keyword">import</span> <span class="token string">'package:flutter_test/flutter_test.dart'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">'package:bloc_provider/main.dart'</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// เราสามารถสร้างกลุ่มของการ Test ครบแต่ละเรื่องที่มีเรื่องใกล้เคียงกันได้</span>
  <span class="token function">group</span><span class="token punctuation">(</span><span class="token string">'My Awesome unit testing'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// test จะใช้กับ Unit Testing</span>
    <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'App start with value 0'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// สร้าง Widget MyHomePage</span>
      <span class="token keyword">var</span> myHomePage <span class="token operator">=</span> <span class="token function">MyHomePage</span><span class="token punctuation">(</span>title<span class="token punctuation">:</span> <span class="token string">'Test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// สร้าง State ของ MyHomePage</span>
      <span class="token keyword">var</span> state <span class="token operator">=</span> myHomePage<span class="token punctuation">.</span><span class="token function">createState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>_counter<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ลองกด F5 เพื่อรัน Test ก็จะพบว่าพัง ซึ่งไม่ต้องรัน VSCode ก็บอกแล้วล่ะว่าพัง
เนื่องจากหา state._counter ไม่เจอ (การเขียน '_' หรือ Underscore นำหน้าชื่อตัวแปรเป็นการกำหนด private ในภาษา Dart ทำให้ไม่สามารถเข้าถึงจาก class ภายนอกได้)</p> <p><code>lib/main.dart</code></p> <div class="language-dart extra-class"><div class="highlight-lines"><br><div class="highlighted"> </div><br></div><pre class="language-dart"><code><span class="token keyword">class</span> <span class="token class-name">_MyHomePageState</span> <span class="token keyword">extends</span> <span class="token class-name">State</span><span class="token operator">&lt;</span>MyHomePage<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  int _counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre></div><p>ซึ่งเราสามารถแก้จาก <code>_counter</code> เป็น <code>counter</code> ก็ได้ แต่จะกลายเป็นว่าไปแก้ความ private ของตัวแปรเราให้เป็น public ซะเฉยๆ เพราะงั้นผมจึงเลือกที่จะสร้าง Getter ของ counter ขึ้นมาแทน ดังนี้</p> <p><code>lib/main.dart</code></p> <div class="language-dart extra-class"><div class="highlight-lines"><br><br><div class="highlighted"> </div><br></div><pre class="language-dart"><code><span class="token keyword">class</span> <span class="token class-name">_MyHomePageState</span> <span class="token keyword">extends</span> <span class="token class-name">State</span><span class="token operator">&lt;</span>MyHomePage<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  int _counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  int <span class="token keyword">get</span> counter <span class="token operator">=</span><span class="token operator">&gt;</span> _counter<span class="token punctuation">;</span>
</code></pre></div><p>แล้วจึงไปแก้ไฟล์ <code>test/unit_test.dart</code> เป็น</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token function">expect</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>counter<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>รันดูก็จะพบว่าสำเร็จแล้ว เฮ</p> <p>แล้วถ้าผมอยากทดสอบการบวกล่ะ ก็จะเจอปัญหาอีกเพราะว่า <code>_incrementCounter</code> เป็น private (อีกแล้ว!! 😵)
ดังนั้นผมจะยังไม่แก้แล้วกัน เพราะก็เหมือนด้านบนเราต้องไปแก้การเข้าถึงของฟังก์ชัน
ในที่นี้ผมก็จะลบ <code>unit_test.dart</code> ทิ้งไปก่อนแล้วกันครับ</p> <div class="tip custom-block"><p class="custom-block-title">Tips</p> <p>เราสามารถรันทุกเทสในโปรเจคเราได้ด้วยการใช้คำสั่ง flutter test 💡</p></div> <h2 id="การเขียนในรูปแบบเริ่มต้น"><a href="#การเขียนในรูปแบบเริ่มต้น" class="header-anchor">#</a> การเขียนในรูปแบบเริ่มต้น</h2> <h3 id="ข้อดี"><a href="#ข้อดี" class="header-anchor">#</a> ข้อดี</h3> <ol><li>เขียนง่าย เขียนได้เรื่อยๆ ไม่ต้องคิดมาก</li></ol> <h3 id="ข้อเสีย"><a href="#ข้อเสีย" class="header-anchor">#</a> ข้อเสีย</h3> <ol><li>ถ้าแอปใหญ่ขึ้นจะเริ่มมีปัญหาการส่งค่าไปๆมาๆในแอป</li> <li>มีปัญหาด้าน Performance (แอปเล็กไม่มีปัญหา)</li> <li>ทำ Unit Testing ได้ลำบาก</li></ol> <p>จากข้างต้นแล้วถ้าเราเปลี่ยนโค้ดใหม่แยกส่วนประกอบต่างๆออกเป็น Widget ย่อยๆเพื่อให้โค้ดอ่านง่ายขึ้น</p> <p><code>lib/main.dart</code></p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">class</span> <span class="token class-name">DisplayCounter</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{</span>
  <span class="token keyword">final</span> int _counter<span class="token punctuation">;</span>

  <span class="token function">DisplayCounter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_counter<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata symbol">@override</span>
  Widget <span class="token function">build</span><span class="token punctuation">(</span>BuildContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">Column</span><span class="token punctuation">(</span>
      mainAxisAlignment<span class="token punctuation">:</span> MainAxisAlignment<span class="token punctuation">.</span>center<span class="token punctuation">,</span>
      children<span class="token punctuation">:</span> <span class="token operator">&lt;</span>Widget<span class="token operator">&gt;</span><span class="token punctuation">[</span>
        <span class="token function">Text</span><span class="token punctuation">(</span>
          <span class="token string">'You have pushed the button this many times:'</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">Text</span><span class="token punctuation">(</span>
          <span class="token string">'$_counter'</span><span class="token punctuation">,</span>
          style<span class="token punctuation">:</span> Theme<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span>textTheme<span class="token punctuation">.</span>display1<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">FAButton</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{</span>
  <span class="token keyword">final</span> <span class="token keyword">Function</span> _incrementCounter<span class="token punctuation">;</span>

  <span class="token function">FAButton</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_incrementCounter<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata symbol">@override</span>
  Widget <span class="token function">build</span><span class="token punctuation">(</span>BuildContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">FloatingActionButton</span><span class="token punctuation">(</span>
      onPressed<span class="token punctuation">:</span> _incrementCounter<span class="token punctuation">,</span>
      tooltip<span class="token punctuation">:</span> <span class="token string">'Increment'</span><span class="token punctuation">,</span>
      child<span class="token punctuation">:</span> <span class="token function">Icon</span><span class="token punctuation">(</span>Icons<span class="token punctuation">.</span>add<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>แล้วจึงเปลี่ยนส่วนแสดงเป็น</p> <div class="language-dart extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><div class="highlighted"> </div><br><br><br><br></div><pre class="language-dart"><code><span class="token keyword">class</span> <span class="token class-name">_MyHomePageState</span> <span class="token keyword">extends</span> <span class="token class-name">State</span><span class="token operator">&lt;</span>MyHomePage<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  int _counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">_incrementCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _counter<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata symbol">@override</span>
  Widget <span class="token function">build</span><span class="token punctuation">(</span>BuildContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">Scaffold</span><span class="token punctuation">(</span>
      appBar<span class="token punctuation">:</span> <span class="token function">AppBar</span><span class="token punctuation">(</span>
        title<span class="token punctuation">:</span> <span class="token function">Text</span><span class="token punctuation">(</span>widget<span class="token punctuation">.</span>title<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      body<span class="token punctuation">:</span> <span class="token function">Center</span><span class="token punctuation">(</span>
        child<span class="token punctuation">:</span> <span class="token function">DisplayCounter</span><span class="token punctuation">(</span>_counter<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      floatingActionButton<span class="token punctuation">:</span> <span class="token function">FAButton</span><span class="token punctuation">(</span>_incrementCounter<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>เมื่อลองรัน widget_test.dart ก็จะพบว่ายังผ่านอยู่เหมือนเดิม (ถ้าไม่ผ่านแสดงว่าทำอะไรผิดแน่ๆ)</p> <p>คราวนี้ปัญหาเยอะกว่าเดิมอีก Unit Testing จะทำยังไงเนี่ย โค้ดกระจายไปหมดแล้ว!!<br>
...ไม่ต้องตกใจครับ เราจะยังไม่สนใจ Unit Testing ณ ตอนนี้</p> <h3 id="ปัญหา"><a href="#ปัญหา" class="header-anchor">#</a> ปัญหา</h3> <ol><li>ถ้า Widget ที่ต้องการค่า <code>_counter</code> หรือ <code>_incrementCounter</code> ของเรานั้นอยู่ลึก<br>
เราจะต้องทำการส่ง <code>_counter</code> หรือ <code>_incrementCounter</code> เข้าไปใน Widget ตัวถัดๆไปจนกว่าจะถึงตัวที่ใช้ เป็นความลำบากของชีวิตเป็นอย่างยิ่ง</li> <li>ถ้าผมลองใส่ debugPrint() ไปในแต่ละขั้นตอน Build ของ Widget เช่น</li></ol> <div class="language-dart extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-dart"><code><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token metadata symbol">@override</span>
Widget <span class="token function">build</span><span class="token punctuation">(</span>BuildContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">debugPrint</span><span class="token punctuation">(</span><span class="token string">'MyHomePage Built'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">Scaffold</span><span class="token punctuation">(</span>
    appBar<span class="token punctuation">:</span> <span class="token function">AppBar</span><span class="token punctuation">(</span>
      title<span class="token punctuation">:</span> <span class="token function">Text</span><span class="token punctuation">(</span>widget<span class="token punctuation">.</span>title<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    body<span class="token punctuation">:</span> <span class="token function">Center</span><span class="token punctuation">(</span>
      child<span class="token punctuation">:</span> <span class="token function">DisplayCounter</span><span class="token punctuation">(</span>_counter<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    floatingActionButton<span class="token punctuation">:</span> <span class="token function">FAButton</span><span class="token punctuation">(</span>_incrementCounter<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>แล้วรัน <code>widget_test.dart</code> ก็จะพบว่า</p> <div class="language- extra-class"><pre class="language-text"><code>MyApp Built
MyHomePage Built
DisplayCounter Built
FAButton Built
MyHomePage Built
DisplayCounter Built
FAButton Built
</code></pre></div><p>เมื่อ <code>_counter</code> เปลี่ยน Flutter จะทำการ build widget <code>MyHomePage</code> ใหม่รวมไปถึง Widget ที่เป็นลูกก็คือ <code>DisplayCounter</code> และ <code>FAButton</code> ด้วย</p> <h2 id="bloc-ผู้ช่วยให้รอดของเรา"><a href="#bloc-ผู้ช่วยให้รอดของเรา" class="header-anchor">#</a> BLoC ผู้ช่วยให้รอดของเรา</h2> <h3 id="ติดตั้ง-library-ที่จําเป็น"><a href="#ติดตั้ง-library-ที่จําเป็น" class="header-anchor">#</a> ติดตั้ง Library ที่จำเป็น</h3> <p>แก้ไฟล์ <code>pubspec.yaml</code></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">dependencies</span><span class="token punctuation">:</span>
  <span class="token punctuation">...</span>
  <span class="token key atrule">provider</span><span class="token punctuation">:</span> ^3.0.0+1
  <span class="token key atrule">rxdart</span><span class="token punctuation">:</span> ^0.22.1+1

</code></pre></div><p>แล้วรันคำสั่ง <code>flutter pub get</code> (ถ้าใช้ VSCode เมื่อกด Save จะรันให้อัตโนมัติ)</p> <div class="tip custom-block"><p class="custom-block-title">Tips</p> <p><a href="https://pub.dev/packages/provider" target="_blank" rel="noopener noreferrer">Provider<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> เป็น Library ที่ถูกแนะนำในงาน Google I/O 2019 และ<br> <a href="https://pub.dev/packages/rxdart" target="_blank" rel="noopener noreferrer">RxDart<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> เป็น Library ที่ทำให้เราสามารถใช้งาน ReactiveX กับ Dart ได้</p></div> <h3 id="เริ่มเขียนไฟล์-bloc"><a href="#เริ่มเขียนไฟล์-bloc" class="header-anchor">#</a> เริ่มเขียนไฟล์ BLoC</h3> <p>ก่อนอื่นผมจะทำการสร้างไฟล์ <code>lib/blocs/counter_bloc.dart</code> ขึ้นมา</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token keyword">import</span> <span class="token string">'package:rxdart/subjects.dart'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">CounterBloc</span> <span class="token punctuation">{</span>
  <span class="token comment">// กำหนดค่าเริ่มต้นของ counter</span>
  <span class="token keyword">static</span> int initialCounter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">// สร้าง BehaviorSubject เป็นตัวกลางในการส่งผ่านค่า counter เป็น Stream ชนิดหนึ่ง</span>
  BehaviorSubject<span class="token operator">&lt;</span>int<span class="token operator">&gt;</span> _counterController <span class="token operator">=</span> BehaviorSubject<span class="token operator">&lt;</span>int<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Stream สำหรับคนที่จะมา Subscribe</span>
  <span class="token keyword">get</span> stream <span class="token operator">=</span><span class="token operator">&gt;</span> _counterController<span class="token punctuation">.</span>stream<span class="token punctuation">;</span>
  <span class="token comment">// ค่า counter ปัจจุบัน</span>
  <span class="token keyword">get</span> currentCounter <span class="token operator">=</span><span class="token operator">&gt;</span> _counterController<span class="token punctuation">.</span>value <span class="token operator">?</span><span class="token operator">?</span> initialCounter<span class="token punctuation">;</span>

  <span class="token comment">// ฟังก์ชันสำหรับเพิ่มค่า counter</span>
  <span class="token function">increaseCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _counterController<span class="token punctuation">.</span>sink<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>currentCounter <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Stream เมื่อใช้เสร็จก็ควรปิดด้วย</span>
  <span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _counterController<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="เปลี่ยนโปรแกรมเดิมๆของเรา"><a href="#เปลี่ยนโปรแกรมเดิมๆของเรา" class="header-anchor">#</a> เปลี่ยนโปรแกรมเดิมๆของเรา</h3> <p>จากนั้นก็ไปเปลี่ยนไฟล์ <code>lib/main.dart</code> ให้ใช้ <code>CounterBloc</code> ของเรา</p> <div class="language-dart extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-dart"><code><span class="token keyword">import</span> <span class="token string">'package:flutter/material.dart'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'package:provider/provider.dart'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">'blocs/counter_bloc.dart'</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">runApp</span><span class="token punctuation">(</span><span class="token function">MyApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">MyApp</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{</span>
  <span class="token metadata symbol">@override</span>
  Widget <span class="token function">build</span><span class="token punctuation">(</span>BuildContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">debugPrint</span><span class="token punctuation">(</span><span class="token string">'MyApp Built'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Provider<span class="token operator">&lt;</span>CounterBloc<span class="token operator">&gt;</span><span class="token punctuation">(</span>
      builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">CounterBloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      dispose<span class="token punctuation">:</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> _counterBloc<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> _counterBloc<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      child<span class="token punctuation">:</span> <span class="token function">MaterialApp</span><span class="token punctuation">(</span>
        title<span class="token punctuation">:</span> <span class="token string">'Flutter Demo'</span><span class="token punctuation">,</span>
        theme<span class="token punctuation">:</span> <span class="token function">ThemeData</span><span class="token punctuation">(</span>
          primarySwatch<span class="token punctuation">:</span> Colors<span class="token punctuation">.</span>blue<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        home<span class="token punctuation">:</span> <span class="token function">MyHomePage</span><span class="token punctuation">(</span>title<span class="token punctuation">:</span> <span class="token string">'Flutter Demo Home Page'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>จากโค้ดด้านบน ผมจะใช้ <strong>Provider</strong> ในการแจกจ่าย <strong>CounterBloc</strong> ที่ผมเขียนไว้<br>
คิดภาพง่ายๆว่า <strong>Provider</strong> เปรียบเสมือน Storage กลางที่คอยเก็บ <strong>CounterBloc</strong> หรือ <strong>State</strong> ไว้ รอการเรียกใช้จาก Widget ต่างๆไม่ว่าจะที่ไหนในแอปของเรา</p> <div class="language-dart extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><div class="highlighted"> </div><br><br><br><br><br></div><pre class="language-dart"><code><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">class</span> <span class="token class-name">MyHomePage</span> <span class="token keyword">extends</span> <span class="token class-name">StatefulWidget</span> <span class="token punctuation">{</span>
  <span class="token function">MyHomePage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>Key key<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">final</span> String title<span class="token punctuation">;</span>

  <span class="token metadata symbol">@override</span>
  _MyHomePageState <span class="token function">createState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">_MyHomePageState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">_MyHomePageState</span> <span class="token keyword">extends</span> <span class="token class-name">State</span><span class="token operator">&lt;</span>MyHomePage<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token metadata symbol">@override</span>
  Widget <span class="token function">build</span><span class="token punctuation">(</span>BuildContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">debugPrint</span><span class="token punctuation">(</span><span class="token string">'MyHomePage Built'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">Scaffold</span><span class="token punctuation">(</span>
      appBar<span class="token punctuation">:</span> <span class="token function">AppBar</span><span class="token punctuation">(</span>
        title<span class="token punctuation">:</span> <span class="token function">Text</span><span class="token punctuation">(</span>widget<span class="token punctuation">.</span>title<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      body<span class="token punctuation">:</span> <span class="token function">Center</span><span class="token punctuation">(</span>
        child<span class="token punctuation">:</span> <span class="token function">DisplayCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      floatingActionButton<span class="token punctuation">:</span> <span class="token function">FAButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>ในที่นี้เราไม่ต้องส่ง <code>_counter</code> และ <code>_increaseCounter</code> จาก <strong>State</strong> ของ <code>MyHomePage</code> ไปแล้ว เพราะเราสามารถดึงค่าจาก <strong>CounterBloc</strong> ของเราได้ในส่วนที่ต้องการใช้ค่า <code>counter</code></p> <div class="language-dart extra-class"><div class="highlight-lines"><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br></div><pre class="language-dart"><code><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">class</span> <span class="token class-name">DisplayCounter</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{</span>
  <span class="token metadata symbol">@override</span>
  Widget <span class="token function">build</span><span class="token punctuation">(</span>BuildContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">debugPrint</span><span class="token punctuation">(</span><span class="token string">'DisplayCounter Built'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    CounterBloc _counterBloc <span class="token operator">=</span> Provider<span class="token punctuation">.</span>of<span class="token operator">&lt;</span>CounterBloc<span class="token operator">&gt;</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">Column</span><span class="token punctuation">(</span>
      mainAxisAlignment<span class="token punctuation">:</span> MainAxisAlignment<span class="token punctuation">.</span>center<span class="token punctuation">,</span>
      children<span class="token punctuation">:</span> <span class="token operator">&lt;</span>Widget<span class="token operator">&gt;</span><span class="token punctuation">[</span>
        <span class="token function">Text</span><span class="token punctuation">(</span>
          <span class="token string">'You have pushed the button this many times:'</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        StreamBuilder<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span><span class="token punctuation">(</span>
          stream<span class="token punctuation">:</span> _counterBloc<span class="token punctuation">.</span>stream<span class="token punctuation">,</span>
          initialData<span class="token punctuation">:</span> CounterBloc<span class="token punctuation">.</span>initialCounter<span class="token punctuation">,</span>
          builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> snapshot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">Text</span><span class="token punctuation">(</span>
              <span class="token string">'${snapshot.data}'</span><span class="token punctuation">,</span>
              style<span class="token punctuation">:</span> Theme<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span>textTheme<span class="token punctuation">.</span>display1<span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>เราจะใช้คำสั่งด้านล่างเพื่อเอาค่าของ <strong>CounterBloc</strong> จาก <strong>Provider</strong></p> <div class="language-dart extra-class"><pre class="language-dart"><code>CounterBloc _counterBloc <span class="token operator">=</span> Provider<span class="token punctuation">.</span>of<span class="token operator">&lt;</span>CounterBloc<span class="token operator">&gt;</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>และ <strong>Widget StreamBuilder</strong> ใช้ในการ Subscribe หรือรอค่าที่ถูกส่งผ่าน <strong>Stream</strong> มาแล้วสร้างเป็น <strong>Widget</strong> ที่เราต้องการซึ่งในที่นี้คือ <strong>Widget Text</strong><br>
โดยทุกครั้งที่ <strong>counter</strong> มีการเปลี่ยนแปลง <strong>Text</strong> ของเราก็จะถูกอัปเดตค่าใหม่ด้วย</p> <div class="language-dart extra-class"><div class="highlight-lines"><br><br><br><br><br><div class="highlighted"> </div><br><div class="highlighted"> </div><br><br><br><br><br><br></div><pre class="language-dart"><code><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">class</span> <span class="token class-name">FAButton</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{</span>
  <span class="token metadata symbol">@override</span>
  Widget <span class="token function">build</span><span class="token punctuation">(</span>BuildContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">debugPrint</span><span class="token punctuation">(</span><span class="token string">'FAButton Built'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    CounterBloc _counterBloc <span class="token operator">=</span> Provider<span class="token punctuation">.</span>of<span class="token operator">&lt;</span>CounterBloc<span class="token operator">&gt;</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">FloatingActionButton</span><span class="token punctuation">(</span>
      onPressed<span class="token punctuation">:</span> _counterBloc<span class="token punctuation">.</span>increaseCounter<span class="token punctuation">,</span>
      tooltip<span class="token punctuation">:</span> <span class="token string">'Increment'</span><span class="token punctuation">,</span>
      child<span class="token punctuation">:</span> <span class="token function">Icon</span><span class="token punctuation">(</span>Icons<span class="token punctuation">.</span>add<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>เราสามารถเรียกใช้ <code>_counterBloc.increaseCounter</code> ของ <strong>CounterBloc</strong> เพื่อเปลี่ยนแปลงค่าของ <strong>counter</strong> ได้ และทุกๆที่ ที่มีการ Subscribe ก็จะเปลี่ยนแปลงตามๆกันโดยอัตโนมัติ</p> <h3 id="ลองรัน-widget-testing-ใหม่อีกครั้ง"><a href="#ลองรัน-widget-testing-ใหม่อีกครั้ง" class="header-anchor">#</a> ลองรัน Widget Testing ใหม่อีกครั้ง</h3> <p>ก็จะพบว่าโปรแกรมยังทำงานได้อย่างถูกต้องเหมือนเดิม เย่ 🎉<br>
แต่สิ่งที่มันต่างออกไปก็คือ</p> <div class="language- extra-class"><pre class="language-text"><code>MyApp Built
MyHomePage Built
DisplayCounter Built
FAButton Built
</code></pre></div><p>จะมีการ build <strong>Widget</strong> ทั้งหมดแค่ครั้งเดียวเท่านั้นไม่มีการ build อย่างสูญเปล่าอีกแล้ว<br>
โดยที่จะ build ใหม่มีแค่ <strong>Text</strong> ที่อยู่ใน <strong>StreamBuilder</strong> เท่านั้น</p> <h2 id="เริ่มเขียน-unit-testing-กันเถอะ"><a href="#เริ่มเขียน-unit-testing-กันเถอะ" class="header-anchor">#</a> เริ่มเขียน Unit Testing กันเถอะ</h2> <p>พอเราแยกส่วนของ Business Logic ออกจากส่วนของ UI เราก็สามารถทำการทดสอบเฉพาะส่วนได้(โดยง่าย)แล้ว</p> <p>ก่อนอื่นผมจะสร้างไฟล์ <code>test/unit_test.dart</code> ขึ้นมา</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token keyword">import</span> <span class="token string">'package:bloc_provider/blocs/counter_bloc.dart'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'package:flutter_test/flutter_test.dart'</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">group</span><span class="token punctuation">(</span><span class="token string">'Test CounterBloc should work perfectly:'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'Counter start with value of zero'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      CounterBloc _counterBloc <span class="token operator">=</span> <span class="token function">CounterBloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>_counterBloc<span class="token punctuation">.</span>currentCounter<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'Get correct counter value after call increaseCounter'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      CounterBloc _counterBloc <span class="token operator">=</span> <span class="token function">CounterBloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      _counterBloc<span class="token punctuation">.</span><span class="token function">increaseCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>_counterBloc<span class="token punctuation">.</span>currentCounter<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      _counterBloc<span class="token punctuation">.</span><span class="token function">increaseCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>_counterBloc<span class="token punctuation">.</span>currentCounter<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      _counterBloc<span class="token punctuation">.</span><span class="token function">increaseCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>_counterBloc<span class="token punctuation">.</span>currentCounter<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>เมื่อเสร็จแล้วก็ลองรันดูก็พบว่ารันได้อย่างปกติสุข</p> <p>ดาวน์โหลด Source Code <a href="https://github.com/aliceblock/bloc-provider" target="_blank" rel="noopener noreferrer">ที่นี่<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="สรุป"><a href="#สรุป" class="header-anchor">#</a> สรุป</h2> <p>การเปลี่ยนมาใช้ BLoC ช่วยให้เราสามารถเพิ่มประสิทธิภาพของโปรแกรมของเราให้ดีขึ้น แถมยังช่วยในเรื่องการทำ Testing อีกต่างหาก
ถ้าหากมีข้อสงสัยอะไรสามารถติดต่อผ่าน <a href="https://facebook.com/intception" target="_blank" rel="noopener noreferrer">Facebook Page<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ของผมได้ครับ</p> <hr></div> <footer class="page-edit"><!----> <div data-href="https://blog.intception.me/dev/flutter/bloc-provider.html" data-width="100%" data-numposts="5" class="fb-comments" style="max-width:99%;"></div> <div class="last-updated"><span class="prefix">อัปเดตเมื่อ: </span> <span class="time">1 ปีที่แล้ว</span></div></footer> <!----> </main></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.e8816fbe.js" defer></script><script src="/assets/js/23.98f77880.js" defer></script><script src="/assets/js/2.5511de28.js" defer></script><script src="/assets/js/31.4cee5970.js" defer></script><script src="/assets/js/30.ceffa3ae.js" defer></script><script src="/assets/js/29.6bb21054.js" defer></script><script src="/assets/js/41.a1cbfaa2.js" defer></script>
  </body>
</html>
